---
title: "Direct Connectで繋ぐオンプレミスとAWS"
emoji: "🎃"
type: "tech" # tech: 技術記事
topics: [aws]
published: false
---
## はじめに
先日、AWS Direct Connectに関する勉強会に参加しました。
とても素晴らしい発表やLTばかりで、初学者の私でも理解できることが多かったので、忘れないようにアウトプットとして記事を書きます。
参加したのはこちらのみのるんさんが開催された勉強会です。
https://minorun365.connpass.com/event/285537/

### 概要
主にDirect Connectとそれに関連するGatewayについて書いています。
ネットワークの知識があるとより理解しやすいと思います。

まず簡単に、Direct Connectはオンプレミス環境とAWSの環境を専用の回線で繋ぐサービスです。
なぜか「DC」ではなく「DX」と訳されるようです。

## オンプレミスとAWSを繋ぐ
さて、オンプレミスとAWSを繋ぐにはどのような方法があるでしょうか？
大きく分けて二つあります
- インターネットを通る
- インターネットを通らない（←今回はこっち）

![](/images/b2.png)
インターネットを通る方法としては、「VPN接続」などがあります。
今回はDirect Connectについてなので、VPNについてはまた別の記事で紹介したいと思います。

## Direct Connectに出てくるリソースたち
では、用語がたくさん出てくるので図を交えながら解説していきます。
ですが、まず分かりやすいように先に全体像を載せておきます。
![](/images/b6.png)

### カスタマーゲートウェイ
カスタマーゲートウェイはオンプレミス側の接続口です。
これはAWSリソースとは関係のない一般的なルーターやスイッチらしいです。

実際にDirect Connectで使われるカスタマーゲートウェイを調べてみました。
その中に「Cisco Systems, 7200 Series Routers」というものがあったので検索すると普通のルーターでした。
参考(https://www.cisco.com/c/en/us/support/routers/7200-series-routers/series.html)

このルーターにはDirect Connectの通信に必要な機能要件があるので注意してください。
参考(https://docs.aws.amazon.com/ja_jp/vpn/latest/s2svpn/your-cgw.html)

図では右側にある紫のアイコンです。
![](/images/b8.png)
カスタマーゲートウェイを用意するのは「ユーザー」で、設置はオンプレミス側に置きます。
カスタマーゲートウェイでは、AWSへの宛先を次に説明するDirect Connectロケーション内のルータに向けます。

::: message
VPCのコンソール画面上にカスタマーゲートウェイという項目があります。
これはあくまでもオンプレミスとAWSをVPN接続をする際、AWS側から接続をするための設定です。
AWS上でカスタマーゲートウェイを作成できるという意味ではありません。

そして、Direct Connectの場合はDirect Connect内のルーターへ接続すれば良いので
カスタマーゲートウェイへの接続設定は不要です。
:::

### VGW(Virtual Private Gateway)
AWS側の接続口です。
VPCに引っ付けるやつです。
![](/images/b14.png)

これはAWSのコンソール上から作成します。

### Direct Connectロケーション
オンプレミスとAWSを中継するデータセンターのこと。
これは物理的なデータセンターで、パートナー企業が保有しています。
日本国内にも東京や大阪にあります。
![](/images/b7.png)

ここにはルーターが2つ配置されています。
- AWS側のルーター
- ユーザー側のルーター(以下から選択)
    - ユーザーが用意
    - パートナー企業に用意してもらう

AWS側のルーターはパートナー企業が用意したものになります。
ユーザー側のルーターはユーザーで用意することもできます。
自分たちで管理することでコストの削減が可能です。

### Connection
Direct Connectロケーション内のルーター同士を繋ぐもの。
異なるユーザーやサービスプロバイダ間の接続のことを「クロスコネクト」と言うそうです。
上の図のユーザールーターとAWSルーターを繋ぐ紫の線の部分です。

### LAG(Link Aggregation Group)
LAGは複数のConnectionを論理的に一つにまとめる仕組みです。

私はこのLAGの理解にかなり苦戦しました。
最終的に理解できたことを図にするとこうなりました。
![](/images/b10.png)

私は何が理解できなかったのか？
Q1. Connectionが1本の線だと思っていた
Connectionは複数の物理線でユーザールーターとAWSルーターを繋いでいる。

Q2. なんのためにまとめるのか分からなかった。
まとめることで帯域幅が増える。

例えば、1本が1Gbpsだとすると2本合わせることで1Gbps+1Gbps=2Gbpsになる。
ということは、通信速度が上がるということです。

Q3. 物理線であるConnectionを論理的にまとめるという意味が分からなかった。
物理線はくっつけても1本の線にはなりません。
なぜなら粘土ではないからです。

そこで、ネットワークの流れを制御して、あたかも1本にデータが流れているかのようにできます。
その結果、Q2のメリットが得られます。

### VIF(Virtual Private InterFace)
なんでVPIじゃないんだろう...
これは名前の通り、仮想的なプライベート通信のためのインターフェースです。
オレンジ色の線がVIFです。
![](/images/b12.png)

VIFにはいくつか種類があります。
- プライベートVIF
- パブリックVIF
- トランジットVIF(後ほど登場します)

プライベートVIF
VPCへプライペートIPで接続するための線です。
VIFとVPCは1対1の関係で、VPCへ接続する場合はプライベートVIFを使います。
ということは、上の図はプライベートVIFの図ですね。

パブリックVIF
AWSへパブリックIPで接続するための線
S3やDynamoDBなど、パブリックリソースへ接続する場合はこちら。
パブリックVIFはこんな感じです。
![](/images/b13.png)

### VIFについてもう少し詳しく
VIFは先ほどの、Connection内に論理的に作られた線です。
また論理的にか...という感じですね。

図を見ていきましょう、先ほどのConnectionをさらに拡大してみます。
![](/images/17.png)

では、またまた私が疑問に思ったことを書きます。

Q1. なぜ、わざわざConnection内にVIFを(論理的に)作る必要がある？
プライベートVIFでVPCと繋ぐ例を考えましょう。

Connectionという物理的な線を数あるVPCの数だけ用意するのは大変ですね。
そこで、Connection内にVIFという論理的な線をたくさん作ることで対応ができます。

さらにここで思いしました。Direct Connectは「専用線」であると。
VIFという単位に分けることで複数の専用線が確立されるということですね。

Q2. VIFはどうやって作る？
AWSのコンソール画面からポチポチして作れます。
制限数以内であればいくらでも作れるようです。

ただし、これは後述するConnectionを保有しているアカウントのみが可能です。

Q3. じゃあ、VIFいっぱい作ればいいじゃん！
VIFはConnectionの帯域幅を共有します。
ということはたくさんVIFを作ると、それだけ各VIFの通信速度が遅くなります。

なんだかConnectionとVIFの関係は賃貸契約みたいですね。
部屋(VIF)を借りるには大家さん(Connectionの保有社)にお金を払います。
そして、その建物(Connection)自体のお金は大家さんが払いますね。

もし大家さんが自分の身内なら無料で使わしてくれるかもしれませんね。
なので、重要なのはこの大家さんが誰なのか？という部分です。

### Direct Connectの契約方法
ではVIFは

### 複数のVPC
では、複数のVPCを接続するにはどうすればいいでしょうか。
お金をたくさん払ってVIFを増やせばいいのです。

しかし、それは効率的ではありません。
もっといい方法があります。
このまま書くとかなり長くなりそうなので、また別の記事として書きます。

### Direct Connectの特徴
Direct Connectは専用線を引いています。
そのことから、以下のような特徴があります。
- 帯域幅が広い、通信速度が速い
- 安定した通信
- 大量の転送データの場合、コストが減る可能性もある

## まとめ
Direct Connectは一度勉強したはずでしたが、初耳かな？と思うような内容ばかりでした。
個人学習で触るようなリソースでもないので、恐らくまた忘れるでしょう。

ちなみに、ほとんどが勉強会で話されていた内容です。
参考資料に記載させて頂いた、みのるんさんのパワポをかなりパクらせていただきました。
あとは、BlackBeltの資料が神資料なので是非そちらも見てみて下さい。

参考資料
https://d1.awsstatic.com/webinars/jp/pdf/services/20210209-AWS-Blackbelt-DirectConnect.pdf
