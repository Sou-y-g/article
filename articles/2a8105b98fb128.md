---
title: "VPC peeringã¨EC2ä½¿ã£ã¦pingé£›ã°ã—ã¦ã¿ãŸ"
emoji: "ğŸ˜Š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹
topics: [aws]
published: true
---
## ã¯ã˜ã‚ã«
VPC peeringã‚’ä½œæˆã—ã¦ã€ãã‚Œãã‚Œã®VPCå†…ã«ã‚ã‚‹EC2ã§pingãŒé€šã‚‹ã‹è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

ã¤ã„ã§ã«ã€ä»Šæµè¡Œã‚Šã®EC2 Instance Connect(EIC)ã‚’ä½¿ã£ã¦ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã®EC2ã«æ¥ç¶šã—ã¦ã¿ã¾ã—ãŸã€‚
ãã—ã¦ã„ãã¤ã‹è©°ã¾ã£ãŸç‚¹ã‚‚è§£èª¬ã—ã¦ã„ãã¾ã™ã€‚

### æ¦‚è¦
ä»Šå›ã¯terraformã‚’ä½¿ã£ã¦æ§‹ç¯‰ã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚
terraformã¯ã‚ã¾ã‚Šè§¦ã£ãŸã“ã¨ãŒãªã„ã®ã§ã€å‚è€ƒç¨‹åº¦ã«è¦‹ã¦ä¸‹ã•ã„ã€‚

ä»Šå›ã®ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚ã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã­ã€‚
```
.
â”œâ”€â”€ main.tf
â”œâ”€â”€ provider.tf
â””â”€â”€ variables.tf
```
ä¸€å¿œã€ä»Šå›ã®æ§‹æˆã¯githubã«ã‚³ãƒ¼ãƒ‰ã‚’ã‚ã’ã¦ã„ã¾ã™ã€‚
https://github.com/Sou-y-g/CT-Subject/tree/main/week2/ct2-2

æœ€çµ‚çš„ã«ã¯ã“ã‚“ãªæ„Ÿã˜ã®æ§‹æˆã«ãªã‚Šã¾ã™ã€‚
![](/images/h11.png)

## VPCã¨ã‚µãƒ–ãƒãƒƒãƒˆã®ä½œæˆ
ã§ã¯ã¾ãšVPCã¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆã¨ã—ã¦ã¯ãƒªã‚½ãƒ¼ã‚¹ã¨å¤‰æ•°ã‚’åˆ†ã‘ã¦ã„ã¾ã™ãŒã€ã‚ã‹ã‚Šã‚„ã™ã„ï¼Ÿã‚ˆã†ã«åŒæ™‚ã«è¨˜è¼‰ã—ã¾ã™ã€‚

å¤‰æ•° => ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ
ã®æµã‚Œã§æ›¸ã„ã¦ã„ãã¾ã™ã€‚
```
#AZã®å¤‰æ•°
variable "availability_zone1a" {
  description = "The availability zones1a to use"
  type        = string
  default     ="ap-northeast-1a"
}

#VPC1ã®å¤‰æ•°
variable "vpc1_cidr" {
  description = "The CIDR block for the VPC"
  type        = string
  default     = "10.0.0.0/16"
}

#subnet1ã®å¤‰æ•°
variable "private1_subnet_cidr" {
  description = "The CIDR block for the private1 subnet"
  type        = string
  default     = "10.0.1.0/24"
}

#VPC1ä½œæˆ
resource "aws_vpc" "vpc1" {
  cidr_block = var.vpc1_cidr
}

#VPC1ã®subnet
resource "aws_subnet" "private1" {
  vpc_id = aws_vpc.vpc1.id
  cidr_block = var.private1_subnet_cidr
  availability_zone = var.availability_zone1a
  map_public_ip_on_launch = false
}

#VPC2ã®å¤‰æ•°
variable "vpc2_cidr" {
  description = "The CIDR block for the VPC"
  type        = string
  default     = "172.18.0.0/16"
}

#subnet2ã®å¤‰æ•°
variable "private2_subnet_cidr" {
  description = "The CIDR block for the private2 subnet"
  type        = string
  default     = "172.18.1.0/24"
}

#VPC2ä½œæˆ
resource "aws_vpc" "vpc2" {
  cidr_block = var.vpc2_cidr
}

#VPC2ã®ã‚µãƒ–ãƒãƒƒãƒˆ
resource "aws_subnet" "private2" {
  vpc_id = aws_vpc.vpc2.id
  cidr_block = var.private2_subnet_cidr
  availability_zone = var.availability_zone1a
  map_public_ip_on_launch = false
}
```
å®Ÿéš›ã¯å…¨ã¦ã«tagã‚’å…¥ã‚Œã¦ã„ã¾ã™ãŒã€é•·ããªã‚‹ã®ã§ã‚«ãƒƒãƒˆã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã§VPCã¨ã‚µãƒ–ãƒãƒƒãƒˆãŒã§ãã¾ã—ãŸã€‚
![](/images/h1.png)

ç‰¹ã«å›°ã£ãŸã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã¯falseã«ãªã£ã¦ã„ã¾ã™ãŒã€
ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã¨åˆ†ã‹ã‚Šã‚„ã™ã„ã‚ˆã†ã«æ˜ç¤ºçš„ã«ã‚³ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚
```
map_public_ip_on_launch = false
```

## VPC peeringã®ä½œæˆ
ã§ã¯ã€æ¬¡ã«ã“ã®VPCã‚’peeringæ¥ç¶šã—ã¾ã™ã€‚
```
#VPC peeringä½œæˆ
resource "aws_vpc_peering_connection" "peering" {
  vpc_id = aws_vpc.vpc1.id
  peer_vpc_id = aws_vpc.vpc2.id
  auto_accept = true
}
```

è¨­å®šé …ç›®ã¯å°‘ãªã„ã§ã™ã­ã€‚
æ¥ç¶šå…ƒã®VPCã¨æ¥ç¶šå…ˆã®VPCã‚’è¨­å®šã™ã‚‹ã ã‘ã§ã™ã€‚
![](/images/image_2023-06-22-18-09-50.png)

```
auto_accept = true
```
ã“ã‚Œã¯æ¥ç¶šå…ˆã®VPCã§ã®æ‰¿èªã‚’è‡ªå‹•çš„ã«è¡Œã†è¨­å®šã§ã™ã€‚
æ‰¿èªã¨ã„ã†ã®ã¯ã€æœ¬å½“ã«æ¥ç¶šã—ã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿã«å¯¾ã™ã‚‹æ‰¿èªã§ã™ã€‚

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ãŒå³ã—ãæ‰‹å‹•æ‰¿èªãŒå¿…è¦ãªå ´åˆã¯falseã§ã™ã­ã€‚
## ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
æ¬¡ã¯ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯
ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã€ãƒ«ãƒ¼ãƒˆã‚’ä½œæˆã€ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ«ãƒ¼ãƒˆã‚’å…¥ã‚Œã‚‹ã€‚
ã¨ã„ã†æµã‚Œã§ã™ã€‚
```
#subnet1ã®å¤‰æ•°
variable "subnet1_route_table" {
  description = "The CIDR Block for private subnet route table"
  type = string
  default = "172.18.0.0/16"
}

#subnet1ã®ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
resource "aws_route_table" "subnet1" {
  vpc_id = aws_vpc.vpc1.id
}

#ãƒ«ãƒ¼ãƒˆ
resource "aws_route" "subnet1" {
  destination_cidr_block = var.subnet1_route_table
  route_table_id = aws_route_table.subnet1.id
  vpc_peering_connection_id = aws_vpc_peering_connection.peering.id
}

#ãƒ«ãƒ¼ãƒˆã®å‰²ã‚Šå½“ã¦
resource "aws_route_table_association" "subnet1" {
  subnet_id = aws_subnet.private1.id
  route_table_id = aws_route_table.subnet1.id
}

#subnet2ã®å¤‰æ•°
variable "subnet2_route_table" {
  description = "The CIDR Block for private subnet route table"
  type = string
  default = "10.0.0.0/16"
}

#subnet2ã®ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
resource "aws_route_table" "subnet2" {
  vpc_id = aws_vpc.vpc2.id
}

#ãƒ«ãƒ¼ãƒˆ
resource "aws_route" "subnet2" {
  destination_cidr_block = var.subnet2_route_table
  route_table_id = aws_route_table.subnet2.id
  vpc_peering_connection_id = aws_vpc_peering_connection.peering.id
}

#ãƒ«ãƒ¼ãƒˆã®å‰²ã‚Šå½“ã¦
resource "aws_route_table_association" "subnet2" {
  subnet_id = aws_subnet.private2.id
  route_table_id = aws_route_table.subnet2.id
}
```
å‡ºæ¥ä¸ŠãŒã£ãŸãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
![](/images/h3.png)

ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«VPCåŒå£«ã‚’ç¹‹ã’ã‚‹ã ã‘ãªã®ã§
ä½™è¨ˆãªã‚‚ã®(InternetGatewayã‚„NatGateway)ã¯ä½œæˆã—ã¦ã„ã¾ã›ã‚“ã€‚

ã“ã“ã¾ã§ã§ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éƒ¨åˆ†ã¯ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚
æ¬¡ã‹ã‚‰EC2é–¢é€£ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
```
#EC1ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
resource "aws_security_group" "sg1" {
  name = "allow ICMP"
  vpc_id = aws_vpc.vpc1.id
}

resource "aws_security_group_rule" "sg1_in" {
    type        = "ingress"
    from_port   = -1
    to_port     = -1
    protocol    = "ICMP"
    cidr_blocks = ["172.18.0.0/16"]

    security_group_id = aws_security_group.sg1.id
}

resource "aws_security_group_rule" "sg1_out" {
    type        = "egress"
    from_port   = -1
    to_port     = -1
    protocol    = "ICMP"
    cidr_blocks = ["172.18.0.0/16"]

    security_group_id = aws_security_group.sg1.id
}

#EC2ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
resource "aws_security_group" "sg2" {
  name = "allow ICMP"
  vpc_id = aws_vpc.vpc2.id
}

resource "aws_security_group_rule" "sg2_in" {
    type        = "ingress"
    from_port   = -1
    to_port     = -1
    protocol    = "ICMP"
    cidr_blocks = ["10.0.0.0/16"]

    security_group_id = aws_security_group.sg2.id
}

resource "aws_security_group_rule" "sg2_out" {
    type        = "egress"
    from_port   = -1
    to_port     = -1
    protocol    = "ICMP"
    cidr_blocks = ["10.0.0.0/16"]

    security_group_id = aws_security_group.sg2.id
}
```
ã©ã¡ã‚‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚‚pingç–é€šã®ãŸã‚ã«ICMPã‚’è¨±å¯ã—ã¦ã„ã¾ã™ã€‚
ã“ã“ã§å°‘ã—è©°ã¾ã‚Šã¾ã—ãŸã€‚

### è©°ã¾ã£ãŸã¨ã“ã‚
ä»Šå›ã¯pingã®ç–é€šã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€ICMPã®é€šä¿¡ã‚’è¨±å¯ã—ã¦ã„ã¾ã™ã€‚
ã—ã‹ã—ã€VPC1ã®EC2ã‹ã‚‰VPC2ã®EC2ã«å¯¾ã—ã¦pingã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã£ã¦ã‚‚åå¿œãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

åŸå› ã¯ã€ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ã®é€šä¿¡ã‚’è¨­å®šã—ã¦ã„ãªã‹ã£ãŸã‹ã‚‰ã€ã§ã—ãŸã€‚
(ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã¯ä¿®æ­£ã—ãŸå¾Œã®ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚)

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ä½œæˆã™ã‚‹ã¨
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ã§ã¯å…¨ã¦ã®é€šä¿¡ã‚’é€šã™è¨­å®šã«ãªã£ã¦ã„ã¾ã™ã€‚

terraformãªã©ã®IaCãƒ„ãƒ¼ãƒ«ã§ã¯æ˜ç¤ºçš„ã«è¨­å®šã—ãªã‘ã‚Œã°ãªã‚‰ãªã„ã“ã¨ã‚’å¿˜ã‚Œã¦ã„ã¾ã—ãŸã€‚

ã‚‚ã†ä¸€ç‚¹ã€ã¤ã¾ã¥ããƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã¯ã€ICMPã§ã¯ãªãTCPã§è¨­å®šã—ã¦ã—ã¾ã†ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã—ã‚‡ã†ã‹ã€‚
pingã‚’ç¢ºèªã™ã‚‹ã®ã§ã‚ã‚Œã°ICMPãŒå¿…è¦ã§ã™ã€‚

## EC2ã®ä½œæˆ
ã§ã¯EC2ã‚’ä½œæˆã—ã¾ã™ã€‚

```
#keyã®å¤‰æ•°
variable "key_name" {
  description = "EC2 key"
  default = "ct_key"
}

# æœ€æ–°ã®AMIã‚’å–å¾—
data "aws_ssm_parameter" "amazonlinux_2023" {
  name = "/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64" # x86_64
}

# ã‚µãƒ–ãƒãƒƒãƒˆ1ã®EC2
resource "aws_instance" "ec2-1"{
  ami                         = data.aws_ssm_parameter.amazonlinux_2023.value
  instance_type               = "t2.micro"
  availability_zone           = var.availability_zone1a
  vpc_security_group_ids      = [aws_security_group.sg1.id, aws_security_group.eic_to_ec2.id]
  subnet_id                   = aws_subnet.private1.id
  associate_public_ip_address = false
  key_name                    = var.key_name
}

# ã‚µãƒ–ãƒãƒƒãƒˆ2ã®EC2
resource "aws_instance" "ec2-2"{
  ami                         = data.aws_ssm_parameter.amazonlinux_2023.value
  instance_type               = "t2.micro"
  availability_zone           = var.availability_zone1a
  vpc_security_group_ids      = [aws_security_group.sg2.id]
  subnet_id                   = aws_subnet.private2.id
  associate_public_ip_address = false
  key_name                    = var.key_name
}
```

EC2ã¯t2.microã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
AMIã¯æœ€æ–°ã®Linux2013ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚
![](/images/h5.png)

ã“ã‚Œã§ã‚ã‚‹ç¨‹åº¦ã®æº–å‚™ã¯çµ‚ã‚ã‚Šã¾ã—ãŸã€‚
ã“ã“ã‹ã‚‰EICã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ã£ã¦EC2ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãã¾ã™ã€‚

## EICã®ä½œæˆ
ä»Šã¾ã§ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆã®EC2ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯
ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆã®è¸ã¿å°EC2ã‚„SSM session managerã‚’ä½¿ã£ã¦æ¥ç¶šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

ãã‚ŒãŒã€ã“ã®EC2 Instance Connectã‚’ä½¿ã†ã“ã¨ã§æ¥ç¶šãŒç°¡å˜ã«ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ä»Šå›ã¯ãã‚“ãªä¾¿åˆ©ãªã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã„ã¾ã™ã€‚

ãŸã ã—ã€ã¾ã ç™ºè¡¨ã•ã‚ŒãŸã°ã‹ã‚Šãªã®ã§terraformã§ä½œæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸã€‚
(ã§ãã‚‹ã®ã‹ãªï¼Ÿterraformã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯è¼‰ã£ã¦ã„ãªã‹ã£ãŸ)

ãã®ãŸã‚ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã¯terraform
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«
ã§ä½œæˆã—ã¾ã—ãŸã€‚

```
#è‡ªåˆ†ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
data "http" "ifconfig" {
  url = "http://ipv4.icanhazip.com/"
}

variable "allowed-myip" {
  default = null
}

locals {
  current-ip   = chomp(data.http.ifconfig.body)
  allowed-myip = (var.allowed-myip == null) ? "${local.current-ip}/32" : var.allowed-myip
}

# EICã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
resource "aws_security_group" "sg_eic" {
  name = "for EIC"
  vpc_id = aws_vpc.vpc1.id
}

#ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ SSHã®ã¿
resource "aws_security_group_rule" "sg_eic" {
    type        = "egress"
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    cidr_blocks = ["10.0.0.0/16", local.allowed-myip]

    security_group_id = aws_security_group.sg_eic.id
}

#EICã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆâ†’EC2ã®é€šä¿¡ã‚’è¨±å¯ã™ã‚‹ãŸã‚ã®EC2ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
resource "aws_security_group" "eic_to_ec2" {
  name = "EIC to EC2"
  vpc_id = aws_vpc.vpc1.id
}

resource "aws_security_group_rule" "eic_to_ec2_in" {
    type        = "ingress"
    from_port   = 22
    to_port     = 22
    protocol    = "tcp"
    source_security_group_id = aws_security_group.sg_eic.id
    security_group_id = aws_security_group.eic_to_ec2.id
}

resource "aws_security_group_rule" "eic_to_ec2_out" {
    type        = "egress"
    from_port   = 0
    to_port     = 65535
    protocol    = "tcp"
    source_security_group_id = aws_security_group.sg_eic.id
    security_group_id = aws_security_group.eic_to_ec2.id
}
```

ã§ã¯ã“ã“ã‹ã‚‰EICã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ä½œæˆã—ãŸEC2ã‚’é¸æŠã—ã¾ã™ã€‚
![](/images/h6.png)

æ¬¡ã«ã€ã€ŒEC2 Instance Connect ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦æ¥ç¶šã™ã‚‹ã€ã‚’é¸æŠã€‚
ã€Œã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’é¸æŠã™ã‚‹ã€ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ã€‚
![](/images/h7.png)

ç”»é¢ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ã®ã§ã€EC2 Instance Connect Endpointã‚’é¸æŠã€‚
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ¥ç¶šã™ã‚‹EC2ã®VPCã€ã‚µãƒ–ãƒãƒƒãƒˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã™ã‚‹ã€‚

ã“ã®æ™‚é¸ã¶ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã¯ä¸Šã®ã‚³ãƒ¼ãƒ‰ã®
EICã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç”¨ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã§ã™ã€‚
![](/images/h8.png)

ã‚ã¨ã¯ä½œæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ•°åˆ†å¾…ã¡ã¾ã™ã€‚
...

ãã‚Œã§ã¯ã€ä½œæˆã§ããŸã‚ˆã†ãªã®ã§æ¥ç¶šã—ã¦ã¿ã¾ã™ã€‚
![](/images/h9.png)

ãŠã€æ¥ç¶šã§ãã¾ã—ãŸï¼
ã§ã¯ã€pingã‚’é£›ã°ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼
![](/images/h10.png)

ã¡ã‚ƒã‚“ã¨é£›ã³ã¾ã—ãŸã­ã€‚
ã“ã‚Œã§VPC peeringã‚’é€šã£ã¦VPCé–“ã§æ¥ç¶šã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚
![](/images/h11.png)

### è©°ã¾ã£ãŸã¨ã“ã‚
ã“ã“ã§ã€EICã®è©°ã¾ã£ãŸã¨ã“ã‚ã‚’æ›¸ã„ã¦ãŠãã¾ã™ã€‚

EICã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ãŸå¾Œã€EC2ã«æ¥ç¶šä½¿ç”¨ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸã€‚
ãªã‚“ã§ã‹ãªï¼Ÿã¨æ€ã„ã€ã„ã‚ã„ã‚èª¿ã¹ãŸçµæœEICã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã®ã‚’å¿˜ã‚Œã¦ã„ã¾ã—ãŸã€‚

ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’è¦‹ãªãŒã‚‰ä¸€ã¤ãšã¤ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã¦
å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã§ç¹‹ãŒã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
https://dev.classmethod.jp/articles/ec2-instance-connect-endpoint-private-access/
ãŸã ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œã‚Œã°ç¹‹ãŒã‚‹ï¼ã¨ã„ã†è¨³ã§ã¯ãªã„ã®ã§æ³¨æ„ã§ã™ã€‚

ã¡ãªã¿ã«ã€ã“ã‚Œã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ãŒENIã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã‹ã‚‰ã§ã—ã‚‡ã†ã€‚
EC2ã‚‚ç´°ã‹ãã„ã†ã¨ã€EC2è‡ªèº«ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã‚‹ã®ã§ã¯ãªãã€
EC2ã«ã‚¢ã‚¿ãƒƒãƒã•ã‚ŒãŸENIã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã‚“ã§ã™ã­ã€‚

## ã¾ã¨ã‚
VPC peeringã‚’terraformã§ä½œæˆã—ã¦ã¿ã¾ã—ãŸãŒã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ç¨ã‚ã£ã“ã—ãªãŒã‚‰ãªã‚“ã¨ã‹ä½œæˆã§ãã¾ã—ãŸã€‚
IaCã‚’ä½¿ã†ã¨ç´°ã‹ã„è¨­å®šã¾ã§ãã¡ã‚“ã¨ç›®ã‚’é€šã•ãªã„ã¨ã„ã‘ãªã„ã®ã§å¤§å¤‰å‹‰å¼·ã«ãªã‚Šã¾ã—ãŸã€‚

ã‚ã¨ã€æµè¡Œã‚Šã®ï¼ŸEICã‚’ä½¿ã£ã¦ã¿ã¾ã—ãŸãŒã€ä¾¿åˆ©ã™ãã¦ã³ã£ãã‚Šã—ã¾ã—ãŸã€‚
ä»Šå¾Œã‚‚ä½¿ã†æ©Ÿä¼šãŒå¤šã„ã¨æ€ã†ã®ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä»˜ã‘å¿˜ã‚Œãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¾ã™ã€‚
