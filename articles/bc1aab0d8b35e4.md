---
title: "シェルってなにしてるの"
emoji: "🐚"
type: "tech" # tech: 技術記事
topics: [linux, shell]
published: true
---
## はじめに
先日シェルについてのオンライン勉強会に参加しました。
https://studyco.connpass.com/event/291129/
スライドも非常にわかりやすく、動画もアップされているので、ぜひ見てみて下さい。

何度勉強してもついつい忘れてしますシェルについて、忘れないうちにアウトプットしておきたいと思います。
私の解釈が混ざっているので、詳しく知りたい方は上のURLへ飛んでください。

### 前提
記事内で実行しているコマンドは全てawsのEC2(Amazon Linux2023)で実行したものです。

## シェルってなあに
みなさん「シェル」使ってますか？
使ってますよね？

sh, bash, zsh, csh,etc...
いろんなシェルがありますね。

この「シェル」ってなんでしょうか？
シェルはユーザーが命令したことをカーネルに伝えてくれるやつ。です。
![](/images/v2.png)

でも面倒じゃないですか？
なぜユーザーの命令がそのままカーネルではなく、わざわざシェルを通す必要があるのでしょうか？
それはカーネルがユーザーが入力した文字を理解できないからです。

ということで、「カーネル」を理解しましょう。

## カーネルってなあに
カーネルはOSのコア(核)です。
これではあまりピンとこないと思います。

ではカーネルは何をやっているのでしょう？
主にプロセスやメモリ、ファイルシステムなどの管理をしています。
![](/images/v4.png)

:::message
プロセスとは実行可能なプログラムのことを言います。
少しややこしいですが、プロセス=プログラムではありません。
例えば、Excelというプログラムがメモリ上にロードされて「いつでも動けるで！」となった状態がプロセスです。
:::

プロセスやメモリなど、ソフト側もハード側も管理していますね。
つまり、カーネルはソフトウェアとハードウェアの間の管理を行ってくれているということです。
![](/images/v5.png)

これはどういったところで使われているのでしょうか？

### カーネルの仕事
例えば、今みなさんが開いているブラウザです。
複数のタブを開いている方も多いのではないでしょうか？
1コアのCPUの場合、1つのプロセス(タブ)しか動かすことができません。

しかし、実際にタブを移動すると別のタブが見れますね？
これはタブが移動した際にカーネルが複数のプロセスを高速で切り替えることで、あたかも複数のプロセスが同時に動作しているように見せかけています。
![](/images/v6.png)

カーネルは頑張り屋さんですね〜

ちなみに、今回は1コアのCPUで例えましたが、CPUのコア数が増えると、それだけ並行して処理を行うことができます。

なんとなくカーネルがやっていることがイメージできたましたか？

非常に重要なカーネルですが、カーネルはユーザーの言語を理解することができません。
これは、役割分担やセキュリティ面による理由からです。
![](/images/v7.png)
そのため、我々ユーザーの命令をカーネルに伝えるのがシェルという訳です。

### カーネルとシェルが起動するまで
では、このカーネルやシェルはどこで動いているのでしょうか？
これらはメモリ上で動作しています。

どのようにしてPCの起動からカーネル、そしてシェルが動作するのか見てみましょう。
まずPCを起動すると、最初にCPUがBIOSを起動します。
![](/images/v8.png)

BIOSは簡単にいうと、ハードウェアのチェックや初期化を行なっています。
次にBIOSがストレージにあるブートローダを実行します。
![](/images/v9.png)

ブートローダはカーネルをメモリに読み込ませます。
:::message
ここで疑問に思ったこと
Q. なぜBIOS→カーネルではなくBIOS→ブートローダ→カーネルなのか、ブートローダの役割がよく分からない

A. BIOSはハードウェアの初期化やHDDやUSBのようなデバイスからブートローダを読み込む機能を持っているが、カーネルをメモリにロードして実行することはできない。
ブートローダはメモリ上でカーネルを起動することができ、複数のOSがあればユーザーにどのOSを起動するか選択させることもできる。

要は、それぞれ役割が違いますよ！っていうこと
:::
これでカーネルがメモリ上で動けるようになります。
![](/images/v10.png)

そしてカーネルがinitプロセスを起動します。
initは「初期化」です。
なので、initプロセスは初期状態のプロセス、つまり一番大元の親プロセスということになります。

このinitプロセスを親として、シェルや他の各プログラムが子プロセスとして生まれていきます。
これでカーネルやシェルがどのように起動しているのかが分かりました。

## シェルの仕事
ここまででシェルとカーネルの関係性が見えてきました。
ではここからはシェルがどのようにユーザーの入力したプログラムを実行するのか見ていきます。

そもそもシェルがなければユーザーの入力したコマンドは実行されません。
それどころか、シェルがなければコンピュータにログインすることもできません。
![](/images/v11.png)

つまり、シェルはユーザーとカーネルを繋ぐインタフェースということです。

### コマンド
私たちは普段シェルに対して命令としてコマンドを入力すると思います。
lsとかcatとか...

このコマンドには2つの種類があります。
- 内部コマンド
- 外部コマンド

それぞれ違いを見ていきます。

### 内部コマンド
よく使うものでいえばcd,echo,pwdなどがあります。
これらはシェル自体のプログラムの中に組み込まれています。
![](/images/v13.png)

そのため、`cd`コマンドを実行すると、シェルが自分自身のプログラムを実行します。

### 外部コマンド
先ほどの内部コマンドはシェル内部のコマンドでした。
ということは外部コマンドはシェルの外側のコマンドということです。

代表的な外部コマンドはls, cat, cp, mv...などがあります。

外部コマンドではlsという命令に対してlsの処理が書かれたプログラムファイルを実行しているのです。
よく意味が分かりませんね。

順番に見ていきましょう。
ファイルの一覧を表示する`ls`コマンドを実行します。

しかし、lsという文字列からシェルが勝手にファイルの一覧を表示してくれている訳ではありません。
これはシェル内部に`ls`というプログラムが存在しないからです。
![](/images/v1.png)

ではどうするのか？
シェルはファイル一覧を表示するというプログラムが書かれたファイルを実行する必要があります。
つまり、lsを実行するとシェルはlsの処理が書かれた外部のプログラムファイルを探しにいきます。
![](/images/v12.png)

そして、見つけたlsの処理が書かれたファイルを実行します。
![](/images/v14.png)

この時シェルが探しに行く場所のことを「PATH」といいます。
PATHというと`echo $PATH`と入力すると出力される謎の文字列のことです。
```
$ echo $PATH
/home/ec2-user/.local/bin:/home/ec2-user/bin:/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin
```

これは謎の文字列ではなく、各コマンドの実行内容がプログラムされたファイルの場所を表すものだったのです。

ということは、このPATHの中に自分が実行したいコマンドのプログラムが存在しないとコマンドが実行できないということです。
これがよく言う「PATHが通ってない」というやつです。

### 外部コマンドの実行
各コマンドは一つのプログラムという話をしました。
そして、プログラムを実行するにはプロセスとして実行する必要があるとも言いました。

ということは、コマンドを実行するには新たにプロセスを実行する必要があります。
しかし、シェルではプロセスを実行できません。

そこでシェルはカーネルに対して、新しいプロセス実行して！とお願いします。
これを「システムコール」と呼びます。
![](/images/v15.png)

呼び出されたカーネルはプロセスの実行や、メモリの割り当て、必要なファイル情報を呼び出すためにファイルシステムへのアクセスなどを行い、その結果をシェルへ返します。

こうして、`ls`コマンドでファイルの一覧を取得することができます。

## 内部コマンドと外部コマンドの見分け方
最後に内部と外部のコマンドの見分け方を紹介しておきます。
各コマンドが内部コマンドか外部コマンドかは、`type <コマンド>`で簡単に調べることができます。
```
$ type cat
cat is /usr/bin/cat

$ type echo
echo is a shell builtin
```

`cat`ではパスが出力されたのに対して、`echo`ではshell builtinと返ってきました。

`cat`はパスが表示されたので外部コマンドです。
`echo`はshell builtinつまり、シェルに組み込まれた内部コマンドということです。

## まとめ
簡単にまとめると、シェルとカーネルはOSの一部で、
シェルはユーザーとカーネルの間を取り持ってよしなにしてくれるやつ。
カーネルはソフト(シェルなど)とハードウェアの間を取り持ってよしなにしてくれるやつ。
シェルのコマンドがどうやって実行されているかを知ると、コマンド関連のエラーの時に早く解決できるかもね！
ということです。

かなり長々と書いてしまいました。
普段カーネルなんて意識しながら生きていないので、ああ、そういえば本にそんなことあ書いてあったな〜と思い出しながら勉強することができました。

私の記事ではあまり深くは触れていませんが、勉強会の動画ではもう少し深いところまでお話しされているので、興味がある方はぜひ！

### 参考資料
https://studyco.connpass.com/event/291129/

