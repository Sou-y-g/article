---
title: "AsumeRoleの疑問を一つずつ解決してみた"
emoji: "😸"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [aws]
published: false
---
## はじめに
先日IAMロールについての記事を書いていた際に、AsumeRoleについて調べていました。
調べれば調べるほど、あれ？ここどうなってるんだろう？と疑問が湧いてきたので一つずつ解決していきます。

以前の記事です。
https://zenn.dev/fdnsy/articles/31105a37126d66

### 概要図
まずは以前の記事で書いたIAMロールを使った一時認証の図です。
![](/images/f13.png)

## 用語
では、いくつか用語があるので、まずはなんとなく理解していきましょう。

### STS
Security Token Service(STS)
これは一時的な認証情報を発行してくれるサービスです。
![](/images/i6.png)
### AssumeRole
Assumeとは「引き受ける」みたいな意味です。
Assume Role、つまりIAM RoleをAssume(引き受ける)するということです。

AssumeRoleというRoleが存在している訳ではありません。(コレ重要)
AssumeRoleはユーザーがSTSに対して、ロールを借して！ってお願いする行為です。
![](/images/i1.png)

### 一時的な認証情報
一時的な認証情報とは先ほどからSTSが出してきているものです。
![](/images/i2.png)

一時認証情報はアクセスID、シークレットキーとIAMユーザーと同じ情報を持っています。
以下はAWSの公式ドキュメントの引用です。
>AWS Security Token Service (AWS STS) を使用して、AWS リソースへのアクセスをコントロールできる一時的セキュリティ認証情報を持つ、信頼されたユーザーを作成および提供することができます。

ここから分かるように、STSによって発行されるのは一時的なユーザーと考えていいでしょう。
今回は認証情報が書かれたカードとします。

## 疑問点
少し前置きが長くなりましたが、
ここからは私が感じた疑問点を解決していきます。

### 誰でもAssumeRoleできるの?
できません。
当然ですが、AssumeRoleを行うには条件があります。
![](/images/i9.png)

条件は、
使いたいRole(正確にはSTS)に対してAssumeRoleを行うことができるポリシーを持っていることです。
例えば以下のようなポリシーです。
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "sts:AssumeRole",
            "Resource": "arn:aws:iam::123456789:role/dev-role"
        }
    ]
}
```
このポリシーでは
Resource：dev-roleというロールを借りたいので
Action：stsに対してAssumeRoleができる
ということを定義しています。
対象のロールを借りたいユーザーに、このポリシーをアタッチします。
![](/images/i5.png)

AssumeRoleを行うためのポリシーはリソースに対してもアタッチすることができます。
例えば、Lambdaを作成すると自動的にアタッチされるロールは以下のようになっています。
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Service": "lambda.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
        }
    ]
}
```
普段あまり意識していませんが、リソースから別のリソースを操作する場合は
裏でAssumeRoleが動いています。

### どうやってAssumeRoleするの？
AssumeRoleするにはどのようにしてSTSへリクエストすれば良いのでしょうか？
AssumeRoleしたいと独り言を呟いても認証情報はもらえません。
![](/images/i7.png)
一般的な方法としては
「AWS CLI」「SDK」が使われます。
試しに、AWS CLIを使った呼び出しをしてみましょう。
ちなみに、このリクエストができるのは、先ほどのAssumeRoleができる条件を満たしたユーザー(またはリソース)です。
```
$ aws sts assume-role --role-arn arn:aws:iam::123456789:role/dev-role --role-session-name dev-session --profile dev-user
```
```
#output(値は適当にしています。)
{
    "Credentials": {
        "AccessKeyId": "1234567890ASDFGHJKL",
        "SecretAccessKey": "1234567890asdfghjkl",
        "SessionToken": "1234567890asdfghjkl1234567890asdfghjkl",
        "Expiration": "2023-00-00T00:00:00+00:00"
    },
    "AssumedRoleUser": {
        "AssumedRoleId": "QWERTYUIO1234567890:dev-session",
        "Arn": "arn:aws:sts::123456789:assumed-role/dev-role/dev-session"
    }
}
```
ここでは以下の条件でAssumeRoleを行いました。
借りたいRole名：dev-role
Roleを借りるユーザー：dev-user
セッション名：TestSession

セッション名は、一時認証情報が書かれたカードの名前です。
セッション名があることで、どのセッション名で操作を行なったか？というログが残ります。


## まとめ
AssumeRoleは今回ユーザーで行いましたが、サービスがサービスを操作する際にも使えます。
むしろそちらの方が使用用途としては多いと思います。
### 所感
参考資料
https://dev.classmethod.jp/articles/jaws-ug-cli-sts-handson/
