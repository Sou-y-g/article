---
title: "Session Managerã®è©°ã¾ã‚Šãƒã‚¤ãƒ³ãƒˆ"
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹
topics: [aws]
published: true
---
### ã¯ã˜ã‚ã«
ä»Šå›ã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã®EC2ã«Session Managerã‚’ä½¿ã£ã¦æ¥ç¶šã™ã‚‹æ–¹æ³•ã‚’è§£èª¬ã—ã¾ã™ã€‚
ç§ã¯åˆã‚ã¦Session Managerã‚’ä½¿ã£ãŸæ™‚ã¯ã©ã“ã«ä½•ã‚’ä½œã‚Œã°ã‚ˆã„ã‹åˆ†ã‹ã‚‰ãšéå¸¸ã«è‹¦åŠ´ã—ãŸæ€ã„å‡ºãŒã‚ã‚Šã¾ã™ã€‚
ãã“ã§ã€Session Managerã‚’ä½œæˆã™ã‚‹éš›ã«ã€ã©ã“ã«ä½•ã‚’ä½œã‚Œã°è‰¯ã„ã‹ã®ï¼Ÿã¨ã„ã†éƒ¨åˆ†ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã¯terraformã‚’ä½¿ã£ã¦ä½œæˆã—ã¦ã„ã¾ã™ãŒã€ã©ã“ã«ä½•ã‚’ä½œæˆã™ã‚Œã°è‰¯ã„ã‹ï¼Ÿã¨ã„ã†ã“ã¨ãŒç†è§£ã§ãã‚Œã°
ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã§ã‚‚å•é¡Œãªãä½œæˆã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚
å…¨ä½“ã®ã‚³ãƒ¼ãƒ‰ã¯githubã«ç½®ã„ã¦ã¾ã™ã€‚
https://github.com/Sou-y-g/CT-Subject/tree/main/week8

## Session Manager
ã¾ãšã¯ç°¡å˜ã«Session Managerã®ç‰¹å¾´ã§ã™ã€‚
Session Managerã¯ãƒãƒ¼ãƒˆã«ä¾å­˜ã›ãšã€SSHã‚’ä½¿ã‚ãšã«ãƒ–ãƒ©ã‚¦ã‚¶ãƒ™ãƒ¼ã‚¹ã§EC2ã¸æ¥ç¶šãŒã§ãã‚‹ã¨ã„ã†æ©Ÿèƒ½ã§ã™ã€‚
ã•ã‚‰ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ãƒ­ã‚°ã‚’CloudWatch Logsã‚„S3ã¸ä¿å­˜ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

æœ€è¿‘ã¯EC2 Instance Connect Endpointã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã£ã¦ç°¡å˜ã«ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆã®EC2ã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã—ã‹ã—ã€ã©ã†ã—ã¦ã‚‚SSHã‚’ä½¿ãˆãªã„å ´åˆã‚„ã€æ¥ç¶šã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ­ã‚°ã‚’ç›£æŸ»ã—ãŸã„ã¨ã„ã†å ´åˆã¯ã€CloudWatch Logsã‚„S3ã«ãƒ­ã‚°ã‚’å‡ºåŠ›ã§ãã‚‹Session Managerã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹
ãã‚Œã§ã¯ã€å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
å…ˆã«å…¨ä½“åƒã¯ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
![](/images/p6.png)

ã§ã¯ã€ä¸€ã¤ãšã¤åˆ†è§£ã—ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### SSM Agent
ã¾ãšã¯EC2ã«Systems Managerã®SSM AgentãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
AmazonLinux 2ã‚„AmazonLinux 2023, Ubuntu Serverã®ã‚ˆã†ã«æœ€åˆã‹ã‚‰SSM AgentãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸAMIã‚‚ã‚ã‚Šã¾ã™ã€‚
https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/ami-preinstalled-agent.html

ã“ã®SSM Agentã‚’ä½¿ã£ã¦Systems Managerã«å¯¾ã—ã¦ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’ã™ã‚‹ã“ã¨ã§
ç§ãŸã¡ãŒå‘½ä»¤ã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’Systems ManagerçµŒç”±ã§SSM AgentãŒå—ã‘å–ã‚Šã¾ã™ã€‚
![](/images/p1.png)

SSM Agentã¯EC2ä»¥å¤–ã«ã‚‚ã€ç‰©ç†ã‚µãƒ¼ãƒãƒ¼ã‚„ã€ä»®æƒ³ã‚µãƒ¼ãƒãƒ¼ã«ã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

### VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
Session Managerã§æ¥ç¶šã™ã‚‹å ´åˆã¯3ã¤ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹å‹ã®VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¿…è¦ã§ã™ã€‚
- ec2messages.region.amazonaws.com
- ssm.region.amazonaws.com
- ssmmessages.region.amazonaws.com

![](/images/p2.png)

ã‚³ãƒ¼ãƒ‰ã«ã™ã‚‹ã¨ã“ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
:::details VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
```terraform:vpc.tf
#VPC_Endpoint x3(type:Interface)
resource "aws_vpc_endpoint" "ssm" {
  vpc_id             = aws_vpc.vpc.id
  service_name       = "com.amazonaws.${var.region}.ssm"
  vpc_endpoint_type  = "Interface"
  security_group_ids = [aws_security_group.endpoint-sg.id]
  subnet_ids         = [aws_subnet.private.id]
  private_dns_enabled = true

  tags = {
    Name = "${var.tag}-vpc-endpoint"
  }
}

resource "aws_vpc_endpoint" "ec2messages" {
  vpc_id             = aws_vpc.vpc.id
  service_name       = "com.amazonaws.${var.region}.ec2messages"
  vpc_endpoint_type  = "Interface"
  security_group_ids = [aws_security_group.endpoint-sg.id]
  subnet_ids         = [aws_subnet.private.id]
  private_dns_enabled = true

  tags = {
    Name = "${var.tag}-vpc-endpoint"
  }
}

resource "aws_vpc_endpoint" "ssmmessages" {
  vpc_id             = aws_vpc.vpc.id
  service_name       = "com.amazonaws.${var.region}.ssmmessages"
  vpc_endpoint_type  = "Interface"
  security_group_ids = [aws_security_group.endpoint-sg.id]
  subnet_ids         = [aws_subnet.private.id]
  private_dns_enabled = true

  tags = {
    Name = "${var.tag}-vpc-endpoint"
  }
}
```
:::

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
Session Managerã«æœ€ä½é™å¿…è¦ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã¯2ã¤ã§ã™ã€‚
ã€ŒVPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã€ã¨ã€ŒEC2ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã€ã§ã™ã€‚

ã¾ãšã¯VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã§ã™ã€‚
VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã¯HTTPSã®ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ã®ã¿ãŒå¿…è¦ã§ã™ã€‚
![](/images/p3.png)

:::details VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
```terraform:module/network/main.tf
# Endpoint sg
resource "aws_security_group" "endpoint-sg" {
  name   = "for endpoint"
  vpc_id = aws_vpc.vpc.id

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
  }

  tags = {
    Name = "${var.tag}-endpoint-sg"
  }
}
```
VPCã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚‚EC2ã‚‚åŒã˜VPCå†…ãªã®ã§ã€CIDRç¯„å›²ã¯VPCå†…ã¨ã—ã¦ã„ã¾ã™ã€‚
:::
ã“ã‚Œã¯EC2ã‹ã‚‰ã®é€šä¿¡ã‚’å—ã‘å…¥ã‚Œã‚‹ãŸã‚ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã§ã™ã€‚

æ¬¡ã«EC2ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã§ã™ã€‚
ã“ã‚Œã¯HTTPSã®ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ã®ã¿ãŒå¿…è¦ã§ã™ã€‚
![](/images/p4.png)
:::details EC2ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
```terraform:module/ec2/main.tf 
# EC2 SecurityGroup for connect to SMM
resource "aws_security_group" "sg_ec2" {
  name   = "for connect to ssm"
  vpc_id = var.vpc_id

  egress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = [var.vpc_cidr]
  }

  tags = {
    Name = "${var.tag}-sg"
  }
}
```
:::
æœ€åˆã®èª¬æ˜ã«ã‚ã£ãŸã‚ˆã†ã«ã€EC2ã¯SSM Agentã‚’ä½¿ã£ã¦SSMã«å¯¾ã—ã¦ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’è¡Œã„ã¾ã™ã€‚
ãã®ãŸã‚ã€EC2ã¯ã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰ã§ã¯ãªãã€ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ã‚’è¨­å®šã—ã¾ã™ã€‚

### IAMãƒ­ãƒ¼ãƒ«
Session Managerã‚’ä½¿ã†ãŸã‚ã«ã¯ã€EC2ã«ã€ŒAmazonSSMManagedInstanceCoreã€ã¨ã„ã†ãƒãƒªã‚·ãƒ¼ãŒå¿…è¦ã§ã™ã€‚
![](/images/p5.png)
:::details IAMãƒ­ãƒ¼ãƒ«
```terraform:module/ec2/main.tf
# IAM Role & ä¿¡é ¼ãƒãƒªã‚·ãƒ¼
resource "aws_iam_role" "role" {
  name = "ssm-role"
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "ec2.amazonaws.com"
        }
      }
    ]
  })
}

# Session Managerç”¨ã®Policy
resource "aws_iam_role_policy_attachment" "policy" {
  policy_arn = "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
  role       = aws_iam_role.role.name
}

# Profile
resource "aws_iam_instance_profile" "profile" {
  name = "ssm-profile"
  role = aws_iam_role.role.name
}
```
:::

### æ¥ç¶š
ã“ã‚Œã§å„ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã§ããŸã®ã§ã€EC2ã®ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰æ¥ç¶šã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚
EC2ã®ä¸€è¦§ã‹ã‚‰æ¥ç¶šã™ã‚‹EC2ã‚’é¸æŠã—ã¦ã€Œæ¥ç¶šã€ã‚’æŠ¼ã—ã¾ã™ã€‚
![](/images/p7.png)

æ¬¡ã«ã€ã€Œã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€ã®ã‚¿ãƒ–ã‚’é¸æŠã—ã¦ã€Œæ¥ç¶šã€ã‚’æŠ¼ã—ã¾ã™ã€‚
![](/images/p8.png)

ã“ã‚Œã§æ¥ç¶šãŒã§ãã¾ã—ãŸï¼
![](/images/p9.png)

## æ³¨æ„ç‚¹
### ã‚³ã‚¹ãƒˆ
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹å‹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯æ™‚é–“å˜ä½ã§æ–™é‡‘ãŒã‹ã‹ã‚Šã¾ã™ã€‚
SessionManagerã®å ´åˆã¯æœ€ä½3ã¤ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¿…è¦ãªãŸã‚ã€3ã¤åˆ†ã®æ–™é‡‘ãŒã‹ã‹ã‚Šã¾ã™ã€‚

EC2 Instance Connect Endpointã¯ç„¡æ–™ãªã®ã§ã€ãã‚Œã¨æ¯”ã¹ã‚‹ã¨é«˜ãæ„Ÿã˜ã¦ã—ã¾ã„ã¾ã™ã­ã€‚

### EC2ã®ãƒãƒã‚³ãƒ³ã‹ã‚‰æ¥ç¶šã§ããªã„!
è¨­å®šã¯é–“é•ã„ãªã„ã¯ãšãªã®ã«EC2ã®ãƒãƒã‚³ãƒ³ã‹ã‚‰æ¥ç¶šãŒã§ããªã„ï¼ã¨ã„ã†äº‹ãŒä»¥å‰ã«ä½•åº¦ã‹ã‚ã‚Šã¾ã—ãŸã€‚
ç§ã®çµŒé¨“ã§ã¯ã€å„ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã™ãã®å ´åˆã¯ã€EC2ã®ãƒãƒã‚³ãƒ³ä¸Šã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚
![](/images/p10.png)

å¤§ä½“ã®å ´åˆã¯ã—ã°ã‚‰ãæ™‚é–“ã‚’ç½®ãã¨æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã©ã†ã—ã¦ã‚‚ãƒ€ãƒ¡ãªæ™‚ã¯ã€EC2ã‚’å†èµ·å‹•ã™ã‚‹ã¨ç¹‹ãŒã£ãŸã¨ã„ã†ã“ã¨ã‚‚ã‚ã‚Šã¾ã—ãŸã€‚

ç¹‹ãŒã‚‰ãªã„æ™‚ã¯ä¸€åº¦è©¦ã—ã¦ã¿ã¦ä¸‹ã•ã„ã€‚

## ã¾ã¨ã‚
ä»Šå›ã¯æ„å¤–ã¨ãƒãƒã‚Šã‚„ã™ã„ï¼ŸSession Managerã«ã¤ã„ã¦ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚
SSM AgentãŒãƒãƒ¼ãƒªãƒ³ã‚°ã‚’è¡Œã£ã¦ã„ã‚‹ã¨ã„ã†ã®ã¯çŸ¥ã‚‰ãªã‹ã£ãŸã®ã§ã€ã‚ˆã„å‹‰å¼·ã«ãªã‚Šã¾ã—ãŸã€‚

å‚è€ƒè³‡æ–™
https://dev.classmethod.jp/articles/terraform-session-manager-linux-ec2-vpcendpoint/
